{% comment %}
  Section: Product Slider Tabs
  This section displays product sliders in a tabbed interface.
  Each tab (defined as a block) lets you choose a collection and a tab title.
  The slider is built using Splide and is only initialized and animated when its tab is active.
{% endcomment %}

<!-- Tabbed Section Container -->
<section class="product-slider-tabs">
  <div class="container">
    <div class="column-list _20">
      {% if section.settings.heading %}
        {% assign heading_tag = section.settings.heading_tag | default: 'h2' %}
        <{{ heading_tag }} class="heading-md"><strong>{{ section.settings.heading }}</strong></{{ heading_tag }}>
      {% endif %}
      <div class="uui-text-size-medium">
        {{ section.settings.description }}
      </div>
    </div>
    
    <!-- Tab Buttons (hidden if only 1 tab) -->
    {% if section.blocks.size > 1 %}
      <div class="tabs-buttons" style="display:flex; gap:1rem; margin-bottom:1rem;">
        {% for block in section.blocks %}
          <button class="tab-button {% if forloop.first %}active{% endif %}" data-tab="{{ forloop.index0 }}">
            {{ block.settings.tab_title }}
          </button>
        {% endfor %}
      </div>
    {% endif %}
    
    <!-- Tab Contents -->
    <div class="tabs-content">
      {% for block in section.blocks %}
        <div class="tab-content {% if forloop.first %}active{% else %}hide{% endif %}" data-tab-content="{{ forloop.index0 }}">
          <div class="slider-wrapper">
            <div class="splide" data-auto-scroll-speed="{{ section.settings.auto_scroll_speed }}">
              <div class="splide__track">
                <div class="splide__list">
                  {% assign products = collections[block.settings.collection].products %}
                  {% if products.size > 0 %}
                    {% for product in products %}
                      <div class="splide__slide">
                        <a href="{{ product.url }}" class="prorduct-wrapper">
                          <div class="relative rounded-20">
                            <img class="product-image" 
                                 src="{{ product.featured_image | img_url: '500x' }}" 
                                 alt="{{ product.title }}" 
                                 loading="lazy">
                          </div>
                          <div class="horizontal-between-center">
                            <div class="product-info">
                              <div class="product-name">{{ product.title }}</div>
                              <div class="pricing-2">
                                <small class="starting-at"><em></em></small>{{ product.price | money }}
                              </div>
                            </div>
                          </div>
                        </a>
                      </div>
                    {% endfor %}
                  {% else %}
                    <p>No products found in this collection.</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- Load Splide CSS and JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">
<script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@splidejs/splide-extension-auto-scroll@0.5.3/dist/js/splide-extension-auto-scroll.min.js"></script>

<!-- CSS: Updated Styles -->
<style>
  /* Section wrapper */
  .product-slider-tabs {
    background: linear-gradient(180deg, #000000 0%, #0a0a0a 100%);
    position: relative;
    overflow: hidden;
    padding: 80px 0;
  }

  .product-slider-tabs::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
    pointer-events: none;
  }

  /* Container */
  .product-slider-tabs .container {
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 1440px;
    margin: 0 auto;
    padding-left: 2rem;
    padding-right: 2rem;
    display: flex;
    position: relative;
  }

  /* Heading section */
  .product-slider-tabs .column-list {
    grid-column-gap: 1rem;
    grid-row-gap: 1rem;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    display: flex;
    margin-bottom: 2rem;
  }

  .product-slider-tabs .heading-md {
    font-family: var(--font-heading-family);
    font-size: clamp(2rem, 5vw, 3rem);
    text-align: center;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: white;
    position: relative;
    line-height: 1.2;
    font-weight: 900;
  }

  .product-slider-tabs .heading-md::after {
    content: '';
    display: block;
    width: 60px;
    height: 3px;
    background-color: #ffffff;
    margin: 15px auto 0;
    box-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
  }

  .product-slider-tabs .uui-text-size-medium {
    color: #fff;
    text-align: center;
    max-width: 600px;
  }

  /* Tab Buttons */
  .product-slider-tabs .tabs-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 3rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .product-slider-tabs .tab-button {
    background: transparent;
    border: 2px solid #fff;
    color: #fff;
    padding: 0.75rem 2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: bold;
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 1px;
    border-radius: 4px;
  }

  .product-slider-tabs .tab-button:hover,
  .product-slider-tabs .tab-button.active {
    background: #ffffff;
    color: #000;
    box-shadow: 0 6px 25px rgba(255, 255, 255, 0.5);
  }

  /* Hidden tab content */
  .product-slider-tabs .tab-content.hide {
    display: none;
  }

  /* Slider wrapper */
  .product-slider-tabs .slider-wrapper {
    width: 100%;
    margin-top: 50px;
    position: relative;
  }

  /* Splide list */
  .product-slider-tabs .splide__list {
    grid-column-gap: 32px;
    gap: 32px;
    flex: none;
    display: flex;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  /* Product card/slide */
  .product-slider-tabs .splide__slide {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    border: 3px solid #ffffff;
    box-shadow: 0 8px 30px rgba(255, 255, 255, 0.3);
    transition: all 0.4s ease;
    background: #000;
    width: 350px;
    opacity: 0;
    transform: translateY(20px);
  }

  .product-slider-tabs .splide__slide:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 15px 50px rgba(255, 255, 255, 0.5);
    border-color: #ffffff;
  }

  .product-slider-tabs .splide__slide.animate-slide {
    opacity: 1;
    transform: translateY(0);
    transition: opacity {{ section.settings.slide_animation_speed }}ms ease-out, transform {{ section.settings.slide_animation_speed }}ms ease-out;
  }

  .product-slider-tabs .splide.all-visible .splide__slide {
    opacity: 1 !important;
    transform: none !important;
    transition: none !important;
  }

  /* Product wrapper */
  .product-slider-tabs .prorduct-wrapper {
    display: block;
    text-decoration: none;
  }

  /* Product image container */
  .product-slider-tabs .relative.rounded-20 {
    border-radius: 0;
    overflow: hidden;
    height: 350px;
    width: 100%;
    position: relative;
  }

  .product-slider-tabs .product-image {
    object-fit: cover;
    object-position: 50% 50%;
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Product info */
  .product-slider-tabs .horizontal-between-center {
    padding: 20px;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.95) 100%);
    text-align: center;
    border-top: 2px solid rgba(255, 255, 255, 0.2);
  }

  .product-slider-tabs .product-info {
    width: 100%;
  }

  .product-slider-tabs .product-name {
    font-family: var(--font-heading-family);
    font-size: 1.3rem;
    color: #ffffff;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 800;
  }

  .product-slider-tabs .pricing-2 {
    font-size: 1.5rem;
    font-weight: bold;
    color: #ffffff;
    text-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
  }

  .product-slider-tabs .pricing-2 .starting-at {
    font-size: 0.6em;
    font-style: italic;
    margin-right: 0.25rem;
    color: rgba(255, 255, 255, 0.8);
  }

  /* Slider Animation Styles */
  .product-slider-tabs .splide {
    opacity: 0;
    transform: translateY(50px);
    transition: opacity .3s ease-out, transform .3s ease-out;
  }

  .product-slider-tabs .splide.in-view {
    opacity: 1;
    transform: translateY(0);
  }

  .product-slider-tabs .splide.slider-animate {
    transition-delay: 0.3s;
  }

  /* Hide SR text */
  .product-slider-tabs span.splide__sr {
    display: none;
  }

  /* Remove unused old styles */
  .product-slider-tabs .card-image-2,
  .product-slider-tabs .background-4,
  .product-slider-tabs .bg-image-3 {
    display: none;
  }

  @media (max-width: 768px) {
    .product-slider-tabs {
      padding: 60px 0;
    }

    .product-slider-tabs .splide__slide {
      width: 280px;
    }

    .product-slider-tabs .relative.rounded-20 {
      height: 280px;
    }
  }
</style>

<!-- JavaScript: Tab switching, slider initialization, and animation -->
<script>
// Wait for Splide and extensions to load
function initProductSliderTabs() {
  // Scope everything within the Product Slider Tabs section
  var productSliderTabs = document.querySelector('.product-slider-tabs');
  if (!productSliderTabs) return;

  // Check if Splide is loaded
  if (typeof Splide === 'undefined') {
    console.error('Splide library not loaded');
    return;
  }

  // Function to animate the slider slides (now including clones)
  function animateSplide(splideElement) {
    var animationDelay = {{ section.settings.slide_animation_delay }};
    splideElement.classList.add('in-view', 'slider-animate');
    var slides = splideElement.querySelectorAll('.splide__slide');
    slides.forEach(function(slide, index) {
      setTimeout(function() {
        slide.classList.add('animate-slide');
      }, index * animationDelay);
    });
    var totalDelay = slides.length * animationDelay + 150;
    setTimeout(function() {
      splideElement.classList.add('all-visible');
    }, totalDelay);
  }

  // Function to initialize Splide on a given element if not already initialized.
  function initSplide(splideElement) {
    if(splideElement && !splideElement.classList.contains('splide-initialized')) {
      var autoScrollSpeed = parseInt(splideElement.getAttribute('data-auto-scroll-speed')) || 1;
      var splideInstance = new Splide(splideElement, {
        type: '{{ section.settings.slider_type }}',
        autoWidth: true,
        height: 'auto',
        drag: {{ section.settings.enable_drag | json }},
        arrows: {{ section.settings.show_arrows | json }},
        pagination: {{ section.settings.show_pagination | json }},
        keyboard: {{ section.settings.enable_keyboard | json }},
        wheel: {{ section.settings.enable_wheel | json }},
        speed: {{ section.settings.transition_speed }},
        easing: '{{ section.settings.easing }}',
        label: 'Image Slider',
        perPage: 1,
        perMove: 1,
        gap: '32px',
        focus: 0,
        trimSpace: false,
        clones: 3,
        cloneStatus: false,
        autoScroll: {
          speed: autoScrollSpeed,
          pauseOnHover: {{ section.settings.pause_on_hover | json }},
          pauseOnFocus: {{ section.settings.pause_on_focus | json }},
        },
        breakpoints: {
          991: { autoScroll: { speed: autoScrollSpeed } },
          767: { autoScroll: { speed: autoScrollSpeed } }
        }
      });
      // Mount with autoScroll extension
      try {
        if (typeof window.splide !== 'undefined' && window.splide.Extensions) {
          splideInstance.mount(window.splide.Extensions);
        } else {
          splideInstance.mount();
        }
      } catch(e) {
        console.warn('AutoScroll extension not available, mounting without it', e);
        splideInstance.mount();
      }
      splideElement.classList.add('splide-initialized');
      console.log('Initialized Splide for', splideElement);
      // Trigger the animation once mounted.
      animateSplide(splideElement);
    } else if(splideElement) {
      // Re-run the animation on tab activation.
      splideElement.classList.remove('in-view', 'slider-animate', 'all-visible');
      var slides = splideElement.querySelectorAll('.splide__slide');
      slides.forEach(function(slide){
        slide.classList.remove('animate-slide');
      });
      animateSplide(splideElement);
    }
  }

  // Tab button click event listener (scoped to our section)
  var tabButtons = productSliderTabs.querySelectorAll('.tab-button');
  tabButtons.forEach(function(button) {
    button.addEventListener('click', function() {
      var tabId = button.getAttribute('data-tab');
      // Remove active class from all buttons and hide all tab contents.
      productSliderTabs.querySelectorAll('.tab-button').forEach(function(b) { b.classList.remove('active'); });
      productSliderTabs.querySelectorAll('.tab-content').forEach(function(content) { 
        content.classList.remove('active');
        content.classList.add('hide'); 
      });
      // Set the clicked button and corresponding content as active.
      button.classList.add('active');
      var activeContent = productSliderTabs.querySelector('.tab-content[data-tab-content="'+ tabId +'"]');
      if(activeContent) {
        activeContent.classList.remove('hide');
        activeContent.classList.add('active');
        // Initialize and animate the Splide slider in the active tab.
        var splideElement = activeContent.querySelector('.splide');
        initSplide(splideElement);
      }
    });
  });

  // Initialize the first tab's slider on page load.
  var firstTabContent = productSliderTabs.querySelector('.tab-content.active');
  if(firstTabContent) {
    var splideElement = firstTabContent.querySelector('.splide');
    initSplide(splideElement);
  }
}

// Load when DOM is ready, with delay to ensure scripts are loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initProductSliderTabs, 100);
  });
} else {
  setTimeout(initProductSliderTabs, 100);
}
</script>

{% schema %}
{
  "name": "Product Slider Tabs",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Rep Your Business"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Show off your love for quality auto parts with exclusive products From tees and hats to shop gear, weâ€™ve got something for every car enthusiast."
    },
    {
      "type": "range",
      "id": "auto_scroll_speed",
      "label": "Auto Scroll Speed",
      "default": 1,
      "min": 1,
      "max": 10,
      "step": 1
    },
    {
      "type": "select",
      "id": "heading_tag",
      "label": "Heading tag",
      "options": [
        {"value": "h1", "label": "H1"},
        {"value": "h2", "label": "H2"},
        {"value": "h3", "label": "H3"},
        {"value": "h4", "label": "H4"},
        {"value": "h5", "label": "H5"},
        {"value": "h6", "label": "H6"}
      ],
      "default": "h2"
    },
    {
      "type": "header",
      "content": "Splide Options"
    },
    {
      "type": "select",
      "id": "slider_type",
      "label": "Slider type",
      "options": [
        {"value": "loop", "label": "Loop (infinite)"},
        {"value": "slide", "label": "Slide (finite)"}
      ],
      "default": "loop"
    },
    {
      "type": "range",
      "id": "transition_speed",
      "min": 200,
      "max": 2000,
      "step": 100,
      "label": "Transition speed (ms)",
      "default": 800
    },
    {
      "type": "select",
      "id": "easing",
      "label": "Transition easing",
      "options": [
        {"value": "linear", "label": "Linear"},
        {"value": "ease", "label": "Ease"},
        {"value": "ease-in", "label": "Ease In"},
        {"value": "ease-out", "label": "Ease Out"},
        {"value": "ease-in-out", "label": "Ease In Out"},
        {"value": "cubic-bezier(0.25, 0.46, 0.45, 0.94)", "label": "Smooth"}
      ],
      "default": "ease"
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "label": "Pause autoplay on hover",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "pause_on_focus",
      "label": "Pause autoplay on focus",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_drag",
      "label": "Enable drag/swipe",
      "default": true,
      "info": "Set to 'free' for continuous drag"
    },
    {
      "type": "checkbox",
      "id": "enable_keyboard",
      "label": "Enable keyboard navigation",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_wheel",
      "label": "Enable mouse wheel navigation",
      "default": false
    },
    {
      "type": "header",
      "content": "Display Options"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show navigation arrows",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Show pagination dots",
      "default": false
    },
    {
      "type": "header",
      "content": "Animation Settings"
    },
    {
      "type": "range",
      "id": "slide_animation_speed",
      "label": "Slide animation speed (ms)",
      "min": 100,
      "max": 1000,
      "step": 50,
      "default": 200,
      "info": "Speed of the slide-in animation"
    },
    {
      "type": "range",
      "id": "slide_animation_delay",
      "label": "Delay between slides (ms)",
      "min": 20,
      "max": 200,
      "step": 10,
      "default": 80,
      "info": "Stagger delay between each slide animation"
    }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Tab",
      "settings": [
        {
          "type": "text",
          "id": "tab_title",
          "label": "Tab Title",
          "default": "Tab 1"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        }
      ]
    }
  ],
  "max_blocks": 10,
  "presets": [
    {
      "name": "Product Slider Tabs",
      "category": "Custom"
    }
  ]
}
{% endschema %}
